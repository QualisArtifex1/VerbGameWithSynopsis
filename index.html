<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Latin Verb Practice Game</title>
  <!-- Google Fonts for a Classical Feel -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Global and layout styling with classical colors and gradients */
    body {
      font-family: 'Lora', serif;
      background-color: #fdf6e3; /* Base parchment color */
      background-image: linear-gradient(rgba(210, 180, 140, 0.1), rgba(210, 180, 140, 0.1)), url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5z" fill="%23d2b48c" fill-opacity="0.1" fill-rule="evenodd"/%3E%3C/svg%3E'); /* Subtle texture */
      color: #4a3c2a; /* Darker brown for better contrast */
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 250, 240, 0.95); /* Slightly transparent floral white */
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15), 0 0 0 1px rgba(193, 165, 123, 0.5); /* Softer shadow + border */
      border: 1px solid #c1a57b;
      backdrop-filter: blur(3px);
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    /* Fade-in and fade-out transitions */
    .fade-in { animation: fadeIn 0.5s forwards; }
    .fade-out { animation: fadeOut 0.5s forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    
    h1, h2, h3 {
      margin-bottom: 15px;
      color: #3b2e1a; /* Deep brown */
    }
    h1 {
      font-family: 'Cinzel', serif;
      font-size: 40px;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    h2 {
      font-family: 'Cinzel', serif;
      font-size: 32px;
      text-align: center;
      border-bottom: 1px solid #e0d0b8; /* Subtle underline */
      padding-bottom: 10px;
    }
    h3 { font-size: 22px; }
    
    fieldset {
      border: 1px solid #d4c1a2; /* Lighter border */
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      background: rgba(255, 248, 240, 0.5); /* Slightly different inner background */
    }
    legend {
      font-family: 'Cinzel', serif; /* Use the header font */
      font-weight: 700;
      font-size: 18px; /* Adjusted size */
      padding: 0 10px;
      color: #5a4a3a;
    }
    .checkbox-group, .radio-group {
      display: inline-block;
      margin-right: 20px;
      font-size: 16px;
    }
    .input-group { margin-bottom: 20px; }
    input[type="text"] {
      width: 100%;
      max-width: 300px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #c1a57b;
      border-radius: 4px;
    }
    
    button {
      padding: 12px 28px;
      font-size: 17px;
      font-family: 'Cinzel', serif;
      cursor: pointer;
      background: linear-gradient(145deg, #a57c00, #8c6239); /* Richer gold-brown gradient */
      color: #fff;
      border: none;
      border-radius: 5px;
      transition: all 0.3s ease;
      margin-top: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    button:hover {
      background: linear-gradient(145deg, #b58900, #9c7249);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .option-button {
      background: #fff;
      color: #3b2e1a;
      border: 1px solid #c1a57b;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .option-button:hover { background: #fdf6e3; }
    .option-button:active { box-shadow: inset 0 0 5px rgba(0,0,0,0.3); }
    .option-button.selected {
      background: #8c6239;
      border-color: #3b2e1a;
      color: #fff;
      transform: scale(1.05);
    }
    
    .hidden { display: none; }
    
    #topBar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    #scoreDisplay, #timerDisplay { font-size: 18px; font-family: 'Cinzel', serif; }
    #verbFormDisplay { font-size: 36px; text-align: center; margin-bottom: 5px; font-family: 'Cinzel', serif; }
    #principalPartsDisplay { font-size: 14px; color: #7f6a55; text-align: center; margin-bottom: 25px; }
    .practice-option { margin-bottom: 20px; text-align: center; }
    #correctAnswerDisplay { text-align: center; margin-top: 15px; font-size: 16px; font-style: italic; color: #3b2e1a; }
    
    #recordTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #recordTable th, #recordTable td { border: 1px solid #c1a57b; padding: 8px; text-align: center; }
    #recordTable th { background: #fefcf4; }
    
    .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    .verb-input { width: 100%; padding: 12px; margin: 10px auto; font-size: 16px; display: block; }
    .selected-value { font-weight: bold; }
    .verb-input.hidden { display: none !important; }
    
    /* SYNOPSIS MODE STYLES */
    #synopsisView table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    #synopsisView th, #synopsisView td {
      border: 1px solid #d4c1a2;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    #synopsisView th {
      background: #f5e9d3;
      font-family: 'Cinzel', serif;
      font-weight: 700;
    }
    #synopsisView td:first-child { font-weight: bold; background-color: #fefcf4; }
    #synopsisView input[type="text"] { width: 95%; padding: 6px; font-size: 14px; text-align: center; box-sizing: border-box; background-color: #fff; border-radius: 3px; }
    #synopsisView input.correct { border-color: #2e7d32; background-color: #e8f5e9; }
    #synopsisView input.incorrect { border-color: #c62828; background-color: #ffebee; }
    .correct-answer-feedback { display: block; font-size: 12px; color: #2e7d32; margin-top: 4px; }
    #synopsisScoreDisplay { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; }
    .feedback-icon { font-weight: bold; font-size: 1.2em; margin-left: 4px; vertical-align: middle; }
    .feedback-icon.correct { color: #2e7d32; }
    .feedback-icon.incorrect { color: #c62828; }

    /* Responsive design */
    @media (max-width: 600px) {
      .container { width: 90%; padding: 20px; }
      input[type="text"] { width: 100%; }
      button { width: 100%; box-sizing: border-box; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- SETUP VIEW -->
    <div id="setupView" class="fade-in">
      <h1>Latin Verb Practice Game</h1>
      <p>Select your filters and number of rounds, then click "Start Practice".</p>
      
      <div class="input-group hidden">
        <label for="pp1">Principal Part 1:</label> <input type="text" id="pp1" readonly>
      </div>
      <div class="input-group hidden">
        <label for="pp2">Principal Part 2:</label> <input type="text" id="pp2" readonly>
      </div>
      <div class="input-group hidden">
        <label for="pp3">Principal Part 3:</label> <input type="text" id="pp3" readonly>
      </div>
      <div class="input-group hidden">
        <label for="pp4">Principal Part 4:</label> <input type="text" id="pp4" readonly>
      </div>
      
      <div id="filterOptions">
        <fieldset>
          <legend>Mood</legend>
          <div class="checkbox-group"><label><input type="checkbox" name="filterMood" value="indicative" checked> Indicative</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterMood" value="subjunctive" checked> Subjunctive</label></div>
        </fieldset>
  
        <fieldset>
          <legend>Tense</legend>
          <div class="checkbox-group"><label><input type="checkbox" name="filterTense" value="present" checked> Present</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterTense" value="imperfect" checked> Imperfect</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterTense" value="future" checked> Future</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterTense" value="perfect" checked> Perfect</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterTense" value="pluperfect" checked> Pluperfect</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterTense" value="futureperfect" checked> Future Perfect</label></div>
        </fieldset>
  
        <fieldset>
          <legend>Voice</legend>
          <div class="checkbox-group"><label><input type="checkbox" name="filterVoice" value="active" checked> Active</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterVoice" value="passive" checked> Passive</label></div>
        </fieldset>
  
        <fieldset>
          <legend>Person</legend>
          <div class="checkbox-group"><label><input type="checkbox" name="filterPerson" value="1" checked> 1</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterPerson" value="2" checked> 2</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterPerson" value="3" checked> 3</label></div>
        </fieldset>
  
        <fieldset>
          <legend>Number</legend>
          <div class="checkbox-group"><label><input type="checkbox" name="filterNumber" value="s" checked> Singular</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="filterNumber" value="p" checked> Plural</label></div>
        </fieldset>
      </div>

      <fieldset>
        <legend>Number of Rounds</legend>
        <div class="radio-group"><label><input type="radio" name="roundCount" value="1"> 1</label></div>
        <div class="radio-group"><label><input type="radio" name="roundCount" value="5" checked> 5</label></div>
        <div class="radio-group"><label><input type="radio" name="roundCount" value="10"> 10</label></div>
        <div class="radio-group"><label><input type="radio" name="roundCount" value="15"> 15</label></div>
        <div class="radio-group"><label><input type="radio" name="roundCount" value="20"> 20</label></div>
        <div class="radio-group"><label><input type="radio" name="roundCount" value="25"> 25</label></div>
      </fieldset>

      <fieldset>
        <legend>Mode</legend>
        <div class="radio-group"><label><input type="radio" name="gameMode" value="easy" checked> Matrix Select</label></div>
        <div class="radio-group"><label><input type="radio" name="gameMode" value="hard"> Fill in the Blank</label></div>
        <div class="radio-group"><label><input type="radio" name="gameMode" value="synopsis"> Synopsis</label></div>
      </fieldset>
      
      <div id="synopsisOptions" class="hidden">
        <fieldset>
          <legend>Conjugation</legend>
          <div class="checkbox-group"><label><input type="checkbox" name="synopsisConjugation" value="1" checked> 1</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="synopsisConjugation" value="2" checked> 2</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="synopsisConjugation" value="3" checked> 3</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="synopsisConjugation" value="3io" checked> 3-io</label></div>
          <div class="checkbox-group"><label><input type="checkbox" name="synopsisConjugation" value="4" checked> 4</label></div>
          <span style="font-size: 0.9em; margin-left: 15px; vertical-align: middle;">Having trouble telling the conjugation? Click <a href="https://qualisartifex1.github.io/ConjugationID/" target="_blank" rel="noopener noreferrer">Here</a></span>
        </fieldset>
        <fieldset>
          <legend>Person</legend>
          <div class="radio-group"><label><input type="radio" name="synopsisPerson" value="1"> 1st</label></div>
          <div class="radio-group"><label><input type="radio" name="synopsisPerson" value="2"> 2nd</label></div>
          <div class="radio-group"><label><input type="radio" name="synopsisPerson" value="3" checked> 3rd</label></div>
        </fieldset>
        <fieldset>
          <legend>Number</legend>
          <div class="radio-group"><label><input type="radio" name="synopsisNumber" value="s" checked> Singular</label></div>
          <div class="radio-group"><label><input type="radio" name="synopsisNumber" value="p"> Plural</label></div>
        </fieldset>
      </div>
      
      <button id="startPracticeBtn">Start Practice</button>
    </div>
    
    <!-- PRACTICE VIEW -->
    <div id="practiceView" class="hidden fade-in">
      <div id="topBar">
        <span id="scoreDisplay">Score: 0 / 0</span>
        <span id="timerDisplay">Time: 0s</span>
      </div>
      <div id="questionDisplay">
        <h2 id="verbFormDisplay"></h2>
        <div id="principalPartsDisplay"></div>
        <input type="text" id="verbInput" class="verb-input" placeholder="Type the verb form here" autocomplete="off">
      </div>
      <div id="answerChoices">
        <div class="practice-option" id="optionPerson"><h3>Person</h3></div>
        <div class="practice-option" id="optionNumber"><h3>Number</h3></div>
        <div class="practice-option" id="optionTense"><h3>Tense</h3></div>
        <div class="practice-option" id="optionVoice"><h3>Voice</h3></div>
        <div class="practice-option" id="optionMood"><h3>Mood</h3></div>
      </div>
      <div id="correctAnswerDisplay"></div>
      <button id="checkAnswerBtn">Check Answer</button>
    </div>

    <!-- SYNOPSIS VIEW -->
    <div id="synopsisView" class="hidden fade-in">
        <h1>Verb Synopsis</h1>
        <div id="topBarSynopsis">
          <span id="synopsisScoreDisplay"></span>
          <span id="synopsisTimerDisplay">Time: 0s</span>
        </div>
        <p><em>When necessary, choose the masculine endings.</em></p>
        <p><strong>Principal Parts:</strong> <span id="synopsisPrincipalParts"></span></p>
        <p id="synopsisPrompt">Fill in the forms for the <strong>3rd Person Singular</strong>.</p>
        
        <h3>INDICATIVE</h3>
        <table>
            <thead><tr><th></th><th>Present</th><th>Imperfect</th><th>Future</th></tr></thead>
            <tbody>
                <tr><td>ACTIVE</td><td><input type="text" id="syn-ind-pres-act"></td><td><input type="text" id="syn-ind-imp-act"></td><td><input type="text" id="syn-ind-fut-act"></td></tr>
                <tr><td>PASSIVE</td><td><input type="text" id="syn-ind-pres-pass"></td><td><input type="text" id="syn-ind-imp-pass"></td><td><input type="text" id="syn-ind-fut-pass"></td></tr>
            </tbody>
        </table>
        <table>
            <thead><tr><th></th><th>Perfect</th><th>Pluperfect</th><th>Future Perfect</th></tr></thead>
            <tbody>
                <tr><td>ACTIVE</td><td><input type="text" id="syn-ind-perf-act"></td><td><input type="text" id="syn-ind-plup-act"></td><td><input type="text" id="syn-ind-futperf-act"></td></tr>
                <tr><td>PASSIVE</td><td><input type="text" id="syn-ind-perf-pass"></td><td><input type="text" id="syn-ind-plup-pass"></td><td><input type="text" id="syn-ind-futperf-pass"></td></tr>
            </tbody>
        </table>

        <h3>SUBJUNCTIVE</h3>
        <table>
            <thead><tr><th></th><th>Present</th><th>Imperfect</th><th>Perfect</th><th>Pluperfect</th></tr></thead>
            <tbody>
                <tr><td>ACTIVE</td><td><input type="text" id="syn-subj-pres-act"></td><td><input type="text" id="syn-subj-imp-act"></td><td><input type="text" id="syn-subj-perf-act"></td><td><input type="text" id="syn-subj-plup-act"></td></tr>
                <tr><td>PASSIVE</td><td><input type="text" id="syn-subj-pres-pass"></td><td><input type="text" id="syn-subj-imp-pass"></td><td><input type="text" id="syn-subj-perf-pass"></td><td><input type="text" id="syn-subj-plup-pass"></td></tr>
            </tbody>
        </table>

        <h3>IMPERATIVE</h3>
        <table><tbody>
            <tr><td>SINGULAR</td><td><input type="text" id="syn-imp-sing"></td></tr>
            <tr><td>PLURAL</td><td><input type="text" id="syn-imp-plur"></td></tr>
        </tbody></table>

        <h3>INFINITIVES</h3>
        <table>
            <thead><tr><th>PRES ACT</th><th>PRES PASS</th><th>PERF ACT</th><th>PERF PASS</th><th>FUTURE ACT</th></tr></thead>
            <tbody><tr>
                <td><input type="text" id="syn-inf-pres-act"></td><td><input type="text" id="syn-inf-pres-pass"></td><td><input type="text" id="syn-inf-perf-act"></td><td><input type="text" id="syn-inf-perf-pass"></td><td><input type="text" id="syn-inf-fut-act"></td>
            </tr></tbody>
        </table>

        <h3>PARTICIPLES (Nominative singular only)</h3>
        <table>
            <thead><tr><th>PAP (PRES ACTIVE)</th><th>PPP (PERF PASSIVE)</th><th>FAP (FUTURE ACTIVE)</th></tr></thead>
            <tbody><tr>
                <td><input type="text" id="syn-part-pap"></td><td><input type="text" id="syn-part-ppp"></td><td><input type="text" id="syn-part-fap"></td>
            </tr></tbody>
        </table>

        <button id="checkSynopsisBtn">Check Answers</button>
    </div>
    
    <!-- FINAL VIEW -->
    <div id="finalView" class="hidden fade-in">
      <h1>Session Complete!</h1>
      <p id="finalScoreDisplay"></p>
      <p id="finalTimeDisplay"></p>
      <h2>Review of Your Answers</h2>
      <table id="recordTable">
        <thead><tr><th>#</th><th>Verb (Principal Parts)</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr></thead>
        <tbody id="recordTableBody"></tbody>
      </table>
      <button id="restartBtn">Restart</button>
    </div>
    
    <canvas id="confettiCanvas" class="confetti hidden"></canvas>
  </div>
  
  <script>
    /***********************
     * FULL VERB CONJUGATION LOGIC
     ***********************/
    function removeDiacritics(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
    const genericEndings = { indicative: { active: { perfect: ["i","isti","it","imus","istis","erunt"], pluperfect: ["eram","eras","erat","eramus","eratis","erant"], futurePerfect: ["ero","eris","erit","erimus","eritis","erint"] }, passive: { perfect: ["sum","es","est","sumus","estis","sunt"], pluperfect: ["eram","eras","erat","eramus","eratis","erant"], futurePerfect: ["ero","eris","erit","erimus","eritis","erint"] } }, subjunctive: { active: { perfect: ["erim","eris","erit","erimus","eritis","erint"], pluperfect: ["issem","isses","isset","issemus","issetis","issent"] }, passive: { perfect: ["sim","sis","sit","simus","sitis","sint"], pluperfect: ["essem","esses","esset","essemus","essetis","essent"] } } };
    function getPresentStem1(pp2) { return removeDiacritics(pp2).slice(0, -2); }
    function getPerfectStem1(pp3) { return removeDiacritics(pp3).slice(0, -1); }
    function getSubjunctiveStem1(pp1, pp2) { let stem = getPresentStem1(pp2); return stem.replace(/a$/, "e"); }
    function getPassiveStem1(pp1, pp2, person, number, tense) { let stem = getPresentStem1(pp2); if (tense === "present") { return (person === "1" && number === "s") ? stem.slice(0, -1) : stem; } else { return stem; } }
    const endings1 = { indicative: { active: { present: ["o","s","t","mus","tis","nt"], imperfect: ["bam","bas","bat","bamus","batis","bant"], future: ["bo","bis","bit","bimus","bitis","bunt"], perfect: ["i","isti","it","imus","istis","erunt"], pluperfect: ["eram","eras","erat","eramus","eratis","erant"], futurePerfect: ["ero","eris","erit","erimus","eritis","erint"] }, passive: { present: ["or","ris","tur","mur","mini","ntur"], imperfect: ["bar","baris","batur","bamur","bamini","bantur"], future: ["bor","beris","bitur","bimur","bimini","buntur"], perfect: ["sum","es","est","sumus","estis","sunt"], pluperfect: ["eram","eras","erat","eramus","eratis","erant"], futurePerfect: ["ero","eris","erit","erimus","eritis","erint"] } }, subjunctive: { active: { present: ["m","s","t","mus","tis","nt"], imperfect: ["rem","res","ret","remus","retis","rent"], perfect: ["erim","eris","erit","erimus","eritis","erint"], pluperfect: ["issem","isses","isset","issemus","issetis","issent"] }, passive: { present: ["ar","aris","atur","amur","amini","antur"], imperfect: ["rer","reris","retur","remur","remini","rentur"], perfect: ["sim","sis","sit","simus","sitis","sint"], pluperfect: ["essem","esses","esset","essemus","essetis","essent"] } } };
    function conjugateVerb1(pp1, pp2, pp3, pp4, mood, tense, voice, person, number) { const idx = { "1s": 0, "2s": 1, "3s": 2, "1p": 3, "2p": 4, "3p": 5 }[person + number]; if (mood === 'subjunctive' && tense === 'imperfect') { const endings = voice === 'active' ? ["m","s","t","mus","tis","nt"] : ["r","ris","tur","mur","mini","ntur"]; return removeDiacritics(pp2) + endings[idx]; } const presentSystem = ["present", "imperfect", "future"]; const perfectSystem = ["perfect", "pluperfect", "futurePerfect"]; if (voice === "active") { let stem = ""; if (mood === "indicative" || mood === "subjunctive") { if (tense === "present") { if (mood === "subjunctive") { stem = getSubjunctiveStem1(pp1, pp2); } else { let tempStem = getPresentStem1(pp2); stem = (person === "1" && number === "s") ? tempStem.slice(0, -1) : tempStem; } } else if (["imperfect", "future"].includes(tense)) { stem = getPresentStem1(pp2); } else if (perfectSystem.includes(tense)) { stem = getPerfectStem1(pp3); } } let ending = endings1[mood].active[tense][idx]; return stem + ending; } else if (voice === "passive") { if (presentSystem.includes(tense)) { if (mood === "subjunctive" && tense === "present") { const customEndings = { "1s": "r", "2s": "ris", "3s": "tur", "1p": "mur", "2p": "mini", "3p": "ntur" }; let baseStem = getPresentStem1(pp2); let resultStem = baseStem.replace(/a$/, "e"); let ending = customEndings[person + number]; return resultStem + ending; } else { let stem = getPassiveStem1(pp1, pp2, person, number, tense); let ending = (mood === "indicative") ? endings1.indicative.passive[tense][idx] : endings1.subjunctive.passive[tense][idx]; return stem + ending; } } else if (perfectSystem.includes(tense)) { let participle = (number === "s") ? removeDiacritics(pp4).replace(/(um|us)$/i, "us") : removeDiacritics(pp4).replace(/(us|um)$/i, "i"); let aux = (mood === "indicative") ? endings1.indicative.passive[tense][idx] : endings1.subjunctive.passive[tense][idx]; return participle + " " + aux; } } return ""; }
    function getPresentStem2(pp2) { return removeDiacritics(pp2).slice(0, -2); }
    function getPerfectStem2(pp3) { return removeDiacritics(pp3).slice(0, -1); }
    function getSubjunctiveStem2(pp1, pp2) { let stem = getPresentStem2(pp2); return stem + "a"; }
    function getPassiveStem2(pp1, pp2) { return getPresentStem2(pp2); }
    const endings2 = { indicative: { active: { present: ["o","s","t","mus","tis","nt"], imperfect: ["bam","bas","bat","bamus","batis","bant"], future: ["bo","bis","bit","bimus","bitis","bunt"], perfect: ["i","isti","it","imus","istis","erunt"], pluperfect: ["eram","eras","erat","eramus","eratis","erant"], futurePerfect: ["ero","eris","erit","erimus","eritis","erint"] }, passive: { present: ["or","ris","tur","mur","mini","ntur"], imperfect: ["bar","baris","batur","bamur","bamini","bantur"], future: ["bor","beris","bitur","bimur","bimini","buntur"], perfect: ["sum","es","est","sumus","estis","sunt"], pluperfect: ["eram","eras","erat","eramus","eratis","erant"], futurePerfect: ["ero","eris","erit","erimus","eritis","erint"] } }, subjunctive: { active: { present: ["m","s","t","mus","tis","nt"], imperfect: ["rem","res","ret","remus","retis","rent"], perfect: ["erim","eris","erit","erimus","eritis","erint"], pluperfect: ["issem","isses","isset","issemus","issetis","issent"] }, passive: { present: ["r","ris","tur","mur","mini","ntur"], imperfect: ["rer","reris","retur","remur","remini","rentur"], perfect: ["sim","sis","sit","simus","sitis","sint"], pluperfect: ["essem","esses","esset","essemus","essetis","essent"] } } };
    function conjugateVerb2(pp1, pp2, pp3, pp4, mood, tense, voice, person, number) { const idx = { "1s": 0, "2s": 1, "3s": 2, "1p": 3, "2p": 4, "3p": 5 }[person + number]; if (mood === 'subjunctive' && tense === 'imperfect') { const endings = voice === 'active' ? ["m","s","t","mus","tis","nt"] : ["r","ris","tur","mur","mini","ntur"]; return removeDiacritics(pp2) + endings[idx]; } const presentSystem = ["present", "imperfect", "future"]; const perfectSystem = ["perfect", "pluperfect", "futurePerfect"]; if (voice === "active") { let stem = ""; if (mood === "indicative" || mood === "subjunctive") { if (tense === "present") { if (mood === "subjunctive") { stem = getPresentStem2(pp2) + "a"; } else { stem = getPresentStem2(pp2); } } else if (tense === "imperfect") { stem = getPresentStem2(pp2); } else if (tense === "future") { stem = getPresentStem2(pp2); } else if (perfectSystem.includes(tense)) { stem = getPerfectStem2(pp3); } } let ending = endings2[mood].active[tense][idx]; return stem + ending; } else if (voice === "passive") { if (presentSystem.includes(tense)) { let stem = ""; if (mood === 'subjunctive') { if (tense === 'present') { stem = getPresentStem2(pp2) + "a"; } } else { stem = getPassiveStem2(pp1, pp2); } let ending = (mood === "indicative") ? endings2.indicative.passive[tense][idx] : endings2.subjunctive.passive[tense][idx]; return stem + ending; } else if (perfectSystem.includes(tense)) { let participle = (number === "s") ? removeDiacritics(pp4).replace(/(um|us)$/i, "us") : removeDiacritics(pp4).replace(/(us|um)$/i, "i"); let aux = (mood === "indicative") ? endings2.indicative.passive[tense][idx] : endings2.subjunctive.passive[tense][idx]; return participle + " " + aux; } } return ""; }
    function getPresentStem3(pp2) { return removeDiacritics(pp2).slice(0, -3); }
    function getPerfectStem3(pp3) { return removeDiacritics(pp3).slice(0, -1); }
    function getPassiveStem3(pp1, pp2) { return getPresentStem3(pp2); }
    const endings3rdActivePresent = ["o", "is", "it", "imus", "itis", "unt"]; const endings3rdActiveImperfect = ["ebam", "ebas", "ebat", "ebamus", "ebatis", "ebant"]; const endings3rdActiveFuture = ["am", "es", "et", "emus", "etis", "ent"]; const endings3rdActiveSubjunctiveCorrect = ["am", "as", "at", "amus", "atis", "ant"]; const endings3rdActiveImperfectSubjunctive = ["rem", "res", "ret", "remus", "retis", "rent"]; const endings3rdPassiveSubjunctiveCorrect = ["ar", "aris", "atur", "amur", "amini", "antur"]; const endings3rdPassivePresent = ["or", "eris", "itur", "imur", "imini", "untur"]; const endings3rdPassiveImperfect = ["ebar", "ebaris", "ebatur", "ebamur", "ebamini", "ebantur"]; const endings3rdPassiveFuture = ["ar", "eris", "etur", "emur", "emini", "entur"];
    function conjugateVerb3(pp1, pp2, pp3, pp4, mood, tense, voice, person, number) { const idx = { "1s": 0, "2s": 1, "3s": 2, "1p": 3, "2p": 4, "3p": 5 }[person + number]; if (mood === 'subjunctive' && tense === 'imperfect') { const endings = voice === 'active' ? ["m","s","t","mus","tis","nt"] : ["r","ris","tur","mur","mini","ntur"]; return removeDiacritics(pp2) + endings[idx]; } const presentSystem = ["present", "imperfect", "future"]; const perfectSystem = ["perfect", "pluperfect", "futurePerfect"]; if (perfectSystem.includes(tense)) { if (voice === "active") { let stem = getPerfectStem3(pp3); let ending = (mood === "indicative") ? genericEndings.indicative.active[tense][idx] : genericEndings.subjunctive.active[tense][idx]; return stem + ending; } else if (voice === "passive") { let participle = (number === "s") ? removeDiacritics(pp4).replace(/(um|us)$/i, "us") : removeDiacritics(pp4).replace(/(us|um)$/i, "i"); let aux = (mood === "indicative") ? genericEndings.indicative.passive[tense][idx] : genericEndings.subjunctive.passive[tense][idx]; return participle + " " + aux; } } if (presentSystem.includes(tense)) { if (voice === "active") { if (tense === "present") { if (mood === "indicative") { let stem = getPresentStem3(pp2); let ending = endings3rdActivePresent[idx]; if (idx > 0 && idx < 5) { stem = stem.slice(0, -1) + 'i'; } return (person === '1' && number === 's') ? removeDiacritics(pp1) : getPresentStem3(pp2) + endings3rdActivePresent[idx]; } else if (mood === "subjunctive") { return getPresentStem3(pp2) + endings3rdActiveSubjunctiveCorrect[idx]; } } else if (tense === "imperfect") { if (mood === "indicative") { return getPresentStem3(pp2) + endings3rdActiveImperfect[idx]; } } else if (tense === "future") { return getPresentStem3(pp2) + endings3rdActiveFuture[idx]; } } else if (voice === "passive") { if (tense === "present") { if (mood === "indicative") { let stem = getPassiveStem3(pp1, pp2); let ending = endings3rdPassivePresent[idx]; return stem + ending; } else if (mood === "subjunctive") { return getPassiveStem3(pp1, pp2) + endings3rdPassiveSubjunctiveCorrect[idx]; } } else if (tense === "imperfect") { if (mood === "indicative") { return getPassiveStem3(pp1, pp2) + endings3rdPassiveImperfect[idx]; } } else if (tense === "future") { return getPassiveStem3(pp1, pp2) + endings3rdPassiveFuture[idx]; } } } return ""; }
    function getPresentStem3io(pp1) { return removeDiacritics(pp1).slice(0, -2); }
    function getPerfectStem3io(pp3) { return removeDiacritics(pp3).slice(0, -1); }
    function getPassivePresentIndicative3io(pp1, person, number) { let stem = getPresentStem3io(pp1); return stem + { "1s": "ior", "2s": "eris", "3s": "itur", "1p": "imur", "2p": "imini", "3p": "iuntur" }[person + number]; }
    function conjugateVerb3io(pp1, pp2, pp3, pp4, mood, tense, voice, person, number) { const idx = { "1s": 0, "2s": 1, "3s": 2, "1p": 3, "2p": 4, "3p": 5 }[person + number]; if (mood === 'subjunctive' && tense === 'imperfect') { const endings = voice === 'active' ? ["m","s","t","mus","tis","nt"] : ["r","ris","tur","mur","mini","ntur"]; return removeDiacritics(pp2) + endings[idx]; } const presentSystem = ["present", "imperfect", "future"]; const perfectSystem = ["perfect", "pluperfect", "futurePerfect"]; if (perfectSystem.includes(tense)) { if (voice === "active") { let stem = getPerfectStem3io(pp3); let ending = (mood === "indicative") ? genericEndings.indicative.active[tense][idx] : genericEndings.subjunctive.active[tense][idx]; return stem + ending; } else if (voice === "passive") { let participle = (number === "s") ? removeDiacritics(pp4).replace(/(um|us)$/i, "us") : removeDiacritics(pp4).replace(/(us|um)$/i, "i"); let aux = (mood === "indicative") ? genericEndings.indicative.passive[tense][idx] : genericEndings.subjunctive.passive[tense][idx]; return participle + " " + aux; } } if (presentSystem.includes(tense)) { if (voice === "active") { if (tense === "present") { let stem = getPresentStem3io(pp1); if (mood === "indicative") { return stem + { "1s": "io", "2s": "is", "3s": "it", "1p": "imus", "2p": "itis", "3p": "iunt" }[person + number]; } else if (mood === "subjunctive") { return stem + ["iam", "ias", "iat", "iamus", "iatis", "iant"][idx]; } } else if (tense === "imperfect") { let stem = getPresentStem3io(pp1); if (mood === "indicative") { return stem + ["iebam", "iebas", "iebat", "iebamus", "iebatis", "iebant"][idx]; } } else if (tense === "future") { return getPresentStem3io(pp1) + ["iam", "ies", "iet", "iemus", "ietis", "ient"][idx]; } } else if (voice === "passive") { let stem = getPresentStem3io(pp1); if (tense === "present") { if (mood === "indicative") { return getPassivePresentIndicative3io(pp1, person, number); } else if (mood === "subjunctive") { return stem + ["iar", "iaris", "iatur", "iamur", "iamini", "iantur"][idx]; } } else if (tense === "imperfect") { if (mood === "indicative") { return stem + ["iebar", "iebaris", "iebatur", "iebamur", "iebamini", "iebantur"][idx]; } } else if (tense === "future") { return stem + ["iar", "ieris", "ietur", "iemur", "iemini", "ientur"][idx]; } } } return ""; }
    function getPresentStem4(pp1) { return removeDiacritics(pp1).slice(0, -2); }
    function getPerfectStem4(pp3) { return removeDiacritics(pp3).slice(0, -1); }
    function conjugateVerb4(pp1, pp2, pp3, pp4, mood, tense, voice, person, number) { const idx = { "1s": 0, "2s": 1, "3s": 2, "1p": 3, "2p": 4, "3p": 5 }[person + number]; if (mood === 'subjunctive' && tense === 'imperfect') { const endings = voice === 'active' ? ["m","s","t","mus","tis","nt"] : ["r","ris","tur","mur","mini","ntur"]; return removeDiacritics(pp2) + endings[idx]; } const presentSystem = ["present", "imperfect", "future"]; const perfectSystem = ["perfect", "pluperfect", "futurePerfect"]; const stem = getPresentStem4(pp1); if (voice === "active") { if (presentSystem.includes(tense)) { if (tense === "present") { if (mood === "indicative") { return stem + { "1s": "io", "2s": "is", "3s": "it", "1p": "imus", "2p": "itis", "3p": "iunt" }[person + number]; } else if (mood === "subjunctive") { return stem + ["iam", "ias", "iat", "iamus", "iatis", "iant"][idx]; } } else if (tense === "imperfect") { if (mood === "indicative") { return stem + ["iebam", "iebas", "iebat", "iebamus", "iebatis", "iebant"][idx]; } } else if (tense === "future") { return stem + ["iam", "ies", "iet", "iemus", "ietis", "ient"][idx]; } } if (perfectSystem.includes(tense)) { let perfStem = getPerfectStem4(pp3); let ending = (mood === "indicative") ? genericEndings.indicative.active[tense][idx] : genericEndings.subjunctive.active[tense][idx]; return perfStem + ending; } } else if (voice === "passive") { if (presentSystem.includes(tense)) { if (tense === "present") { if (mood === "indicative") { return stem + { "1s": "ior", "2s": "iris", "3s": "itur", "1p": "imur", "2p": "imini", "3p": "iuntur" }[person + number]; } else if (mood === "subjunctive") { return stem + ["iar", "iaris", "iatur", "iamur", "iamini", "iantur"][idx]; } } else if (tense === "imperfect") { if (mood === "indicative") { return stem + ["iebar", "iebaris", "iebatur", "iebamur", "iebamini", "iebantur"][idx]; } } else if (tense === "future") { return stem + ["iar", "ieris", "ietur", "iemur", "iemini", "ientur"][idx]; } } if (perfectSystem.includes(tense)) { let participle = (number === "s") ? removeDiacritics(pp4).replace(/(um|us)$/i, "us") : removeDiacritics(pp4).replace(/(us|um)$/i, "i"); let aux = (mood === "indicative") ? genericEndings.indicative.passive[tense][idx] : genericEndings.subjunctive.passive[tense][idx]; return participle + " " + aux; } } return ""; }
    function autoDetectConjugation(pp1, pp2) { let infinitive = removeDiacritics(pp2.toLowerCase().trim()); let part1 = removeDiacritics(pp1.toLowerCase().trim()); if (infinitive.endsWith("are")) return "1"; if (infinitive.endsWith("ere")) { if (part1.endsWith("eo")) return "2"; if (part1.endsWith("io")) return "3io"; return "3"; } if (infinitive.endsWith("ire")) return "4"; return "unknown"; }
    function dispatchConjugation(pp1, pp2, pp3, pp4, mood, tense, voice, person, number) { const conj = autoDetectConjugation(pp1, pp2); switch (conj) { case "1": return conjugateVerb1(pp1, pp2, pp3, pp4, mood, tense, voice, person, number); case "2": return conjugateVerb2(pp1, pp2, pp3, pp4, mood, tense, voice, person, number); case "3": return conjugateVerb3(pp1, pp2, pp3, pp4, mood, tense, voice, person, number); case "3io": return conjugateVerb3io(pp1, pp2, pp3, pp4, mood, tense, voice, person, number); case "4": return conjugateVerb4(pp1, pp2, pp3, pp4, mood, tense, voice, person, number); default: return "Unknown Conjugation"; } }
    function getImperative(pp1, pp2, number) { const conj = autoDetectConjugation(pp1, pp2); let stem = ""; let singular = ""; switch (conj) { case "1": stem = removeDiacritics(pp2).slice(0, -3); singular = stem + "a"; break; case "2": stem = removeDiacritics(pp2).slice(0, -2); singular = stem; break; case "3": stem = removeDiacritics(pp2).slice(0, -3); singular = stem + "e"; return (number === 's') ? singular : stem + "ite"; case "3io": stem = removeDiacritics(pp2).slice(0, -3); singular = stem + "e"; return (number === 's') ? singular : stem + "ite"; case "4": stem = removeDiacritics(pp2).slice(0, -3); singular = stem + "i"; break; default: return ""; } return (number === 's') ? singular : singular + "te"; }
    function getInfinitive(pp1, pp2, pp3, pp4, formType) { const conj = autoDetectConjugation(pp1, pp2); const perfectStem = removeDiacritics(pp3).slice(0, -1); const ppp = removeDiacritics(pp4).replace(/um$/, 'us'); const fapStem = removeDiacritics(pp4).slice(0, -2); switch (formType) { case "presentActive": return removeDiacritics(pp2); case "presentPassive": switch (conj) { case "1": return removeDiacritics(pp2).slice(0, -1) + "i"; case "2": return removeDiacritics(pp2).slice(0, -1) + "i"; case "3": return removeDiacritics(pp2).slice(0, -3) + "i"; case "3io": return removeDiacritics(pp2).slice(0, -3) + "i"; case "4": return removeDiacritics(pp2).slice(0, -1) + "i"; } break; case "perfectActive": return perfectStem + "isse"; case "perfectPassive": return removeDiacritics(pp4) + " esse"; case "futureActive": return fapStem + "urum esse"; } return ""; }
    function getParticiple(pp1, pp2, pp4, formType) { const conj = autoDetectConjugation(pp1, pp2); const presentStem = removeDiacritics(pp2).slice(0, -3); switch (formType) { case "pap": switch (conj) { case "1": return removeDiacritics(pp2).slice(0, -2) + "ns"; case "2": return presentStem + "ens"; case "3": return presentStem + "ens"; case "3io": return presentStem + "iens"; case "4": return presentStem + "iens"; } break; case "ppp": return removeDiacritics(pp4).replace(/um$/, 'us'); case "fap": return removeDiacritics(pp4).slice(0, -2) + "urus"; } return ""; }
    
    let totalRounds = 0, currentRound = 0, sessionCorrectCount = 0, currentAnswer = null, answerRevealed = false, sessionStartTime = null, timerInterval = null, sessionRecords = [];
    let allowedMood = [], allowedTense = [], allowedVoice = [], allowedPerson = [], allowedNumber = [];
    let gameMode = 'easy', currentSynopsisAnswers = {}, currentPrincipalParts = [];
    let allowedConjugations = [], synopsisPerson = '3', synopsisNumber = 's';
    
    function startTimer(displayId = "timerDisplay") { sessionStartTime = Date.now(); timerInterval = setInterval(() => { const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000); document.getElementById(displayId).textContent = "Time: " + elapsed + "s"; }, 1000); }
    function stopTimer() { clearInterval(timerInterval); }
    function getCheckedValues(name) { return Array.from(document.querySelectorAll('input[name="' + name + '"]:checked')).map(cb => cb.value.toLowerCase()); }
    function getSelectedRadioValue(name) { const radio = document.querySelector(`input[name="${name}"]:checked`); return radio ? radio.value : null; }
    
    function initializeSession() {
      gameMode = getSelectedRadioValue("gameMode");
      totalRounds = parseInt(getSelectedRadioValue("roundCount"));
      currentRound = 0;
      sessionCorrectCount = 0;
      sessionRecords = [];
      answerRevealed = false;
      
      if (gameMode === 'synopsis') {
          allowedConjugations = getCheckedValues("synopsisConjugation");
          synopsisPerson = getSelectedRadioValue("synopsisPerson");
          synopsisNumber = getSelectedRadioValue("synopsisNumber");
          startTimer('synopsisTimerDisplay');
          nextSynopsis();
      } else {
          allowedMood = getCheckedValues("filterMood");
          allowedTense = getCheckedValues("filterTense");
          allowedVoice = getCheckedValues("filterVoice");
          allowedPerson = getCheckedValues("filterPerson");
          allowedNumber = getCheckedValues("filterNumber");
          updateScoreDisplay();
          startTimer();
          nextQuestion();
      }
    }
    
    function nextQuestion() {
      const randomVerb = verbLibrary[Math.floor(Math.random() * verbLibrary.length)].principalParts;
      currentPrincipalParts = randomVerb;
      const allForms = [];
      const moods = ["indicative", "subjunctive"];
      const tenses = ["present", "imperfect", "future", "perfect", "pluperfect", "futurePerfect"];
      const voices = ["active", "passive"];
      const persons = ["1", "2", "3"];
      const numbers = ["s", "p"];
      moods.forEach(mood => { tenses.forEach(tense => { if (mood === 'subjunctive' && (tense === 'future' || tense === 'futurePerfect')) return; voices.forEach(voice => { persons.forEach(person => { numbers.forEach(number => { const form = dispatchConjugation(...randomVerb, mood, tense, voice, person, number); if (form) allForms.push({ mood, tense, voice, person, number, form }); }); }); }); }); });
      const filteredForms = allForms.filter(row => allowedMood.includes(row.mood) && allowedTense.includes(row.tense) && allowedVoice.includes(row.voice) && allowedPerson.includes(row.person) && allowedNumber.includes(row.number));
      if (filteredForms.length === 0) { alert("No forms available with the current filter settings. Please adjust your filters."); document.getElementById('restartBtn').click(); return; }
      currentAnswer = filteredForms[Math.floor(Math.random() * filteredForms.length)];
      answerRevealed = false;
      currentRound++;
      updateScoreDisplay();
      const masculineNote = (gameMode === 'hard') ? ' <em>When necessary choose the masculine endings.</em>' : '';
      document.getElementById("principalPartsDisplay").innerHTML = `(${randomVerb.join(", ")})${masculineNote}`;
      document.getElementById("correctAnswerDisplay").textContent = "";
      resetOptionHeaders();
      const verbFormEl = document.getElementById("verbFormDisplay"), inputEl = document.getElementById("verbInput"), answerChoicesEl = document.getElementById('answerChoices');
      if (gameMode === 'easy') {
        verbFormEl.classList.remove('hidden');
        inputEl.classList.add('hidden');
        answerChoicesEl.classList.remove('hidden');
        verbFormEl.textContent = currentAnswer.form;
        generateOptionButtons("optionPerson", ["1", "2", "3"]);
        generateOptionButtons("optionNumber", ["s", "p"]);
        generateOptionButtons("optionTense", ["present", "imperfect", "future", "perfect", "pluperfect", "futureperfect"]);
        generateOptionButtons("optionVoice", ["active", "passive"]);
        generateOptionButtons("optionMood", ["indicative", "subjunctive"]);
      } else {
        verbFormEl.classList.add('hidden');
        inputEl.classList.remove('hidden');
        inputEl.value = "";
        answerChoicesEl.classList.remove('hidden');
        const numberLabel = (currentAnswer.number === "s") ? "Singular" : "Plural";
        displayFixedValue("optionPerson", currentAnswer.person);
        displayFixedValue("optionNumber", numberLabel);
        displayFixedValue("optionTense", currentAnswer.tense);
        displayFixedValue("optionVoice", currentAnswer.voice);
        displayFixedValue("optionMood", currentAnswer.mood);
      }
      document.getElementById("checkAnswerBtn").textContent = "Check Answer";
    }

    function nextSynopsis() {
        answerRevealed = false;
        currentRound++;
        const filteredVerbLibrary = verbLibrary.filter(verb => {
            const conj = autoDetectConjugation(verb.principalParts[0], verb.principalParts[1]);
            return allowedConjugations.includes(conj);
        });
        if (filteredVerbLibrary.length === 0) {
            alert("No verbs found for the selected conjugation(s). Please select at least one conjugation.");
            document.getElementById('restartBtn').click();
            return;
        }
        const randomVerb = filteredVerbLibrary[Math.floor(Math.random() * filteredVerbLibrary.length)].principalParts;
        currentPrincipalParts = randomVerb;
        document.getElementById('synopsisPrincipalParts').textContent = randomVerb.join(', ');
        
        const personText = { '1': '1st', '2': '2nd', '3': '3rd' }[synopsisPerson];
        const numberText = { 's': 'Singular', 'p': 'Plural' }[synopsisNumber];
        document.getElementById('synopsisPrompt').innerHTML = `Fill in the forms for the <strong>${personText} Person ${numberText}</strong>.`;

        currentSynopsisAnswers = {
            'syn-ind-pres-act': dispatchConjugation(...randomVerb, 'indicative', 'present', 'active', synopsisPerson, synopsisNumber),
            'syn-ind-imp-act': dispatchConjugation(...randomVerb, 'indicative', 'imperfect', 'active', synopsisPerson, synopsisNumber),
            'syn-ind-fut-act': dispatchConjugation(...randomVerb, 'indicative', 'future', 'active', synopsisPerson, synopsisNumber),
            'syn-ind-perf-act': dispatchConjugation(...randomVerb, 'indicative', 'perfect', 'active', synopsisPerson, synopsisNumber),
            'syn-ind-plup-act': dispatchConjugation(...randomVerb, 'indicative', 'pluperfect', 'active', synopsisPerson, synopsisNumber),
            'syn-ind-futperf-act': dispatchConjugation(...randomVerb, 'indicative', 'futurePerfect', 'active', synopsisPerson, synopsisNumber),
            'syn-ind-pres-pass': dispatchConjugation(...randomVerb, 'indicative', 'present', 'passive', synopsisPerson, synopsisNumber),
            'syn-ind-imp-pass': dispatchConjugation(...randomVerb, 'indicative', 'imperfect', 'passive', synopsisPerson, synopsisNumber),
            'syn-ind-fut-pass': dispatchConjugation(...randomVerb, 'indicative', 'future', 'passive', synopsisPerson, synopsisNumber),
            'syn-ind-perf-pass': dispatchConjugation(...randomVerb, 'indicative', 'perfect', 'passive', synopsisPerson, synopsisNumber),
            'syn-ind-plup-pass': dispatchConjugation(...randomVerb, 'indicative', 'pluperfect', 'passive', synopsisPerson, synopsisNumber),
            'syn-ind-futperf-pass': dispatchConjugation(...randomVerb, 'indicative', 'futurePerfect', 'passive', synopsisPerson, synopsisNumber),
            'syn-subj-pres-act': dispatchConjugation(...randomVerb, 'subjunctive', 'present', 'active', synopsisPerson, synopsisNumber),
            'syn-subj-imp-act': dispatchConjugation(...randomVerb, 'subjunctive', 'imperfect', 'active', synopsisPerson, synopsisNumber),
            'syn-subj-perf-act': dispatchConjugation(...randomVerb, 'subjunctive', 'perfect', 'active', synopsisPerson, synopsisNumber),
            'syn-subj-plup-act': dispatchConjugation(...randomVerb, 'subjunctive', 'pluperfect', 'active', synopsisPerson, synopsisNumber),
            'syn-subj-pres-pass': dispatchConjugation(...randomVerb, 'subjunctive', 'present', 'passive', synopsisPerson, synopsisNumber),
            'syn-subj-imp-pass': dispatchConjugation(...randomVerb, 'subjunctive', 'imperfect', 'passive', synopsisPerson, synopsisNumber),
            'syn-subj-perf-pass': dispatchConjugation(...randomVerb, 'subjunctive', 'perfect', 'passive', synopsisPerson, synopsisNumber),
            'syn-subj-plup-pass': dispatchConjugation(...randomVerb, 'subjunctive', 'pluperfect', 'passive', synopsisPerson, synopsisNumber),
            'syn-imp-sing': getImperative(randomVerb[0], randomVerb[1], 's'), 'syn-imp-plur': getImperative(randomVerb[0], randomVerb[1], 'p'),
            'syn-inf-pres-act': getInfinitive(...randomVerb, 'presentActive'), 'syn-inf-pres-pass': getInfinitive(...randomVerb, 'presentPassive'),
            'syn-inf-perf-act': getInfinitive(...randomVerb, 'perfectActive'), 'syn-inf-perf-pass': getInfinitive(...randomVerb, 'perfectPassive'),
            'syn-inf-fut-act': getInfinitive(...randomVerb, 'futureActive'),
            'syn-part-pap': getParticiple(randomVerb[0], randomVerb[1], randomVerb[3], 'pap'),
            'syn-part-ppp': getParticiple(randomVerb[0], randomVerb[1], randomVerb[3], 'ppp'),
            'syn-part-fap': getParticiple(randomVerb[0], randomVerb[1], randomVerb[3], 'fap'),
        };
        const inputs = document.querySelectorAll('#synopsisView input[type="text"]');
        inputs.forEach(input => { input.value = ''; input.className = ''; const parentTd = input.parentNode; parentTd.querySelectorAll('.correct-answer-feedback, .feedback-icon').forEach(el => el.remove()); });
        document.getElementById('synopsisScoreDisplay').textContent = `Round ${currentRound} of ${totalRounds}`;
        document.getElementById('checkSynopsisBtn').textContent = "Check Answers";
    }
    
    function updateScoreDisplay() { document.getElementById("scoreDisplay").textContent = "Score: " + sessionCorrectCount + " / " + (currentRound - 1); }
    const defaultHeaders = { optionPerson: "Person", optionNumber: "Number", optionTense: "Tense", optionVoice: "Voice", optionMood: "Mood" };
    function generateOptionButtons(containerId, options) { const container = document.getElementById(containerId); const headerText = defaultHeaders[containerId]; container.innerHTML = `<h3>${headerText}</h3>`; options.forEach(opt => { const btn = document.createElement("button"); const displayOpt = opt === 's' ? 'Singular' : opt === 'p' ? 'Plural' : opt; btn.textContent = displayOpt.charAt(0).toUpperCase() + displayOpt.slice(1); btn.dataset.value = opt; btn.classList.add("option-button"); btn.addEventListener("click", function() { if (!answerRevealed) { Array.from(container.querySelectorAll("button")).forEach(b => b.classList.remove("selected")); btn.classList.add("selected"); } }); container.appendChild(btn); }); }
    function displayFixedValue(containerId, value) { const container = document.getElementById(containerId); const headerEl = container.querySelector("h3"); const label = defaultHeaders[containerId]; headerEl.innerHTML = `${label}: <span class="selected-value">${value.charAt(0).toUpperCase() + value.slice(1)}</span>`; }
    function resetOptionHeaders() { for (const id in defaultHeaders) { const container = document.getElementById(id); if (container) { container.innerHTML = `<h3>${defaultHeaders[id]}</h3>`; } } }
    
    function normalizeAnswer(str) { return removeDiacritics(str).toLowerCase().trim().replace(/\s+/g, ' '); }
    function checkAnswer() { if (answerRevealed) { if (currentRound < totalRounds) { nextQuestion(); } else { endSession(); } return; } answerRevealed = true; let isCorrect = false; let userAnswerDisplay, correctAnswerDisplay; if (gameMode === 'easy') { const selectedPerson = getSelectedOption("optionPerson"); const selectedNumber = getSelectedOption("optionNumber"); const selectedTense = getSelectedOption("optionTense"); const selectedVoice = getSelectedOption("optionVoice"); const selectedMood = getSelectedOption("optionMood"); if (!selectedPerson || !selectedNumber || !selectedTense || !selectedVoice || !selectedMood) { alert("Please make a selection in every category."); answerRevealed = false; return; } isCorrect = selectedPerson === currentAnswer.person && selectedNumber === currentAnswer.number && selectedTense === currentAnswer.tense.toLowerCase().replace('perfect', '') && selectedVoice === currentAnswer.voice && selectedMood === currentAnswer.mood; userAnswerDisplay = `${selectedPerson}, ${selectedNumber}, ${selectedTense}, ${selectedVoice}, ${selectedMood}`; } else { const userInput = document.getElementById("verbInput").value; if (!userInput) { alert("Please type the verb form."); answerRevealed = false; return; } isCorrect = normalizeAnswer(userInput) === normalizeAnswer(currentAnswer.form); userAnswerDisplay = userInput; } const numberLabel = (currentAnswer.number === "s") ? "Singular" : "Plural"; correctAnswerDisplay = `${currentAnswer.form} (${currentAnswer.person}, ${numberLabel}, ${currentAnswer.tense}, ${currentAnswer.voice}, ${currentAnswer.mood})`; document.getElementById("correctAnswerDisplay").innerHTML = `Correct Answer: ${correctAnswerDisplay}`; flashFeedback(isCorrect); if (isCorrect) sessionCorrectCount++; updateScoreDisplay(); sessionRecords.push({ verb: `(${currentPrincipalParts.join(", ")})`, studentAnswer: userAnswerDisplay, correctAnswer: correctAnswerDisplay, result: isCorrect ? "Correct" : "Incorrect" }); document.getElementById("checkAnswerBtn").textContent = (currentRound < totalRounds) ? "Next Verb" : "Finish"; }
    function checkSynopsis() { if (answerRevealed) { if (currentRound < totalRounds) { nextSynopsis(); } else { endSession(); } return; } answerRevealed = true; let correctCount = 0; const totalInputs = Object.keys(currentSynopsisAnswers).length; for (const id in currentSynopsisAnswers) { const input = document.getElementById(id); const parentTd = input.parentNode; const userAnswer = normalizeAnswer(input.value); const correctAnswer = normalizeAnswer(currentSynopsisAnswers[id]); let isCorrect = userAnswer === correctAnswer; const iconEl = document.createElement('span'); iconEl.className = 'feedback-icon'; if (isCorrect) { correctCount++; input.classList.add('correct'); iconEl.classList.add('correct'); iconEl.textContent = ''; } else { input.classList.add('incorrect'); iconEl.classList.add('incorrect'); iconEl.textContent = ''; const feedbackEl = document.createElement('span'); feedbackEl.className = 'correct-answer-feedback'; feedbackEl.textContent = currentSynopsisAnswers[id]; parentTd.appendChild(feedbackEl); } input.insertAdjacentElement('afterend', iconEl); } sessionCorrectCount += correctCount; const synopsisRoundScore = `${correctCount} / ${totalInputs} Correct`; document.getElementById('synopsisScoreDisplay').textContent = `Round ${currentRound} of ${totalRounds} | Score: ${synopsisRoundScore}`; sessionRecords.push({ verb: `(${currentPrincipalParts.join(", ")})`, studentAnswer: `Synopsis attempt`, correctAnswer: `See detailed forms`, result: `${correctCount}/${totalInputs}` }); document.getElementById("checkSynopsisBtn").textContent = (currentRound < totalRounds) ? "Next Verb" : "Finish"; }
    function getSelectedOption(containerId) { const container = document.getElementById(containerId); const btn = container.querySelector("button.selected"); return btn ? btn.dataset.value : null; }
    function flashFeedback(isCorrect) { const view = document.getElementById("practiceView"); const original = view.style.backgroundColor; view.style.backgroundColor = isCorrect ? "#c8e6c9" : "#ffcdd2"; setTimeout(() => { view.style.backgroundColor = ""; }, 400); }
    
    function endSession() { stopTimer(); document.getElementById("practiceView").classList.add("hidden"); document.getElementById("synopsisView").classList.add("hidden"); document.getElementById("finalView").classList.remove("hidden"); const totalPossibleScore = (gameMode === 'synopsis') ? totalRounds * 30 : totalRounds; document.getElementById("finalScoreDisplay").textContent = `Your Score: ${sessionCorrectCount} / ${totalPossibleScore}`; const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000); document.getElementById("finalTimeDisplay").textContent = "Time Elapsed: " + elapsed + " seconds"; buildRecordTable(); if (sessionCorrectCount === totalPossibleScore) { showConfetti(); } }
    function buildRecordTable() { const tbody = document.getElementById("recordTableBody"); tbody.innerHTML = ""; sessionRecords.forEach((record, index) => { const tr = document.createElement("tr"); tr.innerHTML = `<td>${index + 1}</td><td>${record.verb}</td><td>${record.studentAnswer}</td><td>${record.correctAnswer}</td><td>${record.result}</td>`; tbody.appendChild(tr); }); }
    
    function showConfetti() { const confettiCanvas = document.getElementById("confettiCanvas"); confettiCanvas.classList.remove("hidden"); const ctx = confettiCanvas.getContext("2d"); confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; let particles = []; for (let i = 0; i < 100; i++) { particles.push({ x: Math.random() * confettiCanvas.width, y: Math.random() * confettiCanvas.height - confettiCanvas.height, r: Math.random() * 6 + 2, d: Math.random() * 30 + 1, color: "hsl(" + Math.floor(Math.random() * 360) + ", 100%, 50%)" }); } function draw() { ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height); particles.forEach(p => { ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2, true); ctx.closePath(); ctx.fill(); }); update(); } function update() { particles.forEach(p => { p.y += Math.cos(p.d) + 1 + p.r / 2; p.x += Math.sin(p.d); if (p.y > confettiCanvas.height) { p.y = 0; p.x = Math.random() * confettiCanvas.width; } }); } let confettiInterval = setInterval(draw, 20); setTimeout(() => { clearInterval(confettiInterval); confettiCanvas.classList.add("hidden"); }, 3000); }
    
    document.getElementById("startPracticeBtn").addEventListener("click", function() { gameMode = getSelectedRadioValue("gameMode"); const setupView = document.getElementById("setupView"); setupView.classList.add("fade-out"); setTimeout(() => { setupView.classList.add("hidden"); setupView.classList.remove("fade-out"); let targetViewId = (gameMode === 'synopsis') ? 'synopsisView' : 'practiceView'; const targetView = document.getElementById(targetViewId); targetView.classList.remove("hidden"); targetView.classList.add("fade-in"); initializeSession(); }, 500); });
    document.querySelectorAll('input[name="gameMode"]').forEach(radio => { radio.addEventListener('change', function() { const filterOptions = document.getElementById('filterOptions'); const synopsisOptions = document.getElementById('synopsisOptions'); if (this.value === 'synopsis') { filterOptions.style.display = 'none'; synopsisOptions.classList.remove('hidden'); document.querySelector('input[name="roundCount"][value="1"]').checked = true; } else { filterOptions.style.display = 'block'; synopsisOptions.classList.add('hidden'); document.querySelector('input[name="roundCount"][value="5"]').checked = true; } }); });
    document.getElementById("checkAnswerBtn").addEventListener("click", checkAnswer);
    document.getElementById("checkSynopsisBtn").addEventListener("click", checkSynopsis);
    document.getElementById("restartBtn").addEventListener("click", function() { const finalView = document.getElementById("finalView"); finalView.classList.add("fade-out"); setTimeout(() => { finalView.classList.add("hidden"); finalView.classList.remove("fade-out"); const setupView = document.getElementById("setupView"); setupView.classList.remove("hidden"); setupView.classList.add("fade-in"); }, 500); });
    
    const verbLibrary = [ { principalParts: ["scio","scire","scivi","scitum"] }, { principalParts: ["reperio","reperire","repperi","repertum"] }, { principalParts: ["dormio","dormire","dormivi","dormitum"] }, { principalParts: ["venio","venire","veni","ventum"] }, { principalParts: ["audio","audire","audivi","auditum"] }, { principalParts: ["sentio","sentire","sensi","sensum"] }, { principalParts: ["convenio","convenire","conveni","conventum"] }, { principalParts: ["aperio","aperire","aperui","apertum"] }, { principalParts: ["invenio","invenire","inveni","inventum"] }, { principalParts: ["colo","colere","colui","cultum"] }, { principalParts: ["cresco","crescere","crevi","cretum"] }, { principalParts: ["curro","currere","cucurri","cursum"] }, { principalParts: ["trado","tradere","tradidi","traditum"] }, { principalParts: ["pendo","pendere","pependi","pensum"] }, { principalParts: ["tego","tegere","texi","tectum"] }, { principalParts: ["fallo","fallere","fefelli","falsum"] }, { principalParts: ["fundo","fundere","fudi","fusum"] }, { principalParts: ["spargo","spargere","sparsi","sparsum"] }, { principalParts: ["surgo","surgere","surrexi","surrectum"] }, { principalParts: ["effundo","effundere","effudi","effusum"] }, { principalParts: ["fluo","fluere","fluxi","fluxum"] }, { principalParts: ["credo","credere","credidi","creditum"] }, { principalParts: ["quaero","quaerere","quaesivi","quaesitum"] }, { principalParts: ["cognosco","cognoscere","cognovi","cognitum"] }, { principalParts: ["disco","discere","didici",null] }, { principalParts: ["intellego","intellegere","intellexi","intellectum"] }, { principalParts: ["cerno","cernere","crevi","cretum"] }, { principalParts: ["decerno","decernere","decrevi","decretum"] }, { principalParts: ["contemno","contemnere","contempsi","contemptum"] }, { principalParts: ["rideo","ridere","risi","risum"] }, { principalParts: ["statuo","statuere","statui","statutum"] }, { principalParts: ["vivo","vivere","vixi","victum"] }, { principalParts: ["gigno","gignere","genui","genitum"] }, { principalParts: ["alo","alere","alui","altum"] }, { principalParts: ["consumo","consumere","consumpsi","consumptum"] }, { principalParts: ["quiesco","quiescere","quievi","quietum"] }, { principalParts: ["diligo","diligere","dilexi","dilectum"] }, { principalParts: ["compono","componere","composui","compositum"] }, { principalParts: ["iungo","iungere","iunxi","iunctum"] }, { principalParts: ["divido","dividere","divisi","divisum"] }, { principalParts: ["constituo","constituere","constitui","constitutum"] }, { principalParts: ["fingo","fingere","finxi","fictum"] }, { principalParts: ["impono","imponere","imposui","impositum"] }, { principalParts: ["peto","petere","petivi","petitum"] }, { principalParts: ["relinquo","relinquere","reliqui","relictum"] }, { principalParts: ["verto","vertere","verti","versum"] }, { principalParts: ["sumo","sumere","sumpsi","sumptum"] }, { principalParts: ["desero","deserere","deserui","desertum"] }, { principalParts: ["procedo","procedere","processi","processum"] }, { principalParts: ["pergo","pergere","perrexi","perrectum"] }, { principalParts: ["converto","convertere","converti","conversum"] }, { principalParts: ["intendo","intendere","intendi","intentum"] }, { principalParts: ["adverto","advertere","adverti","adversum"] }, { principalParts: ["reverto","revertere","reverti","reversum"] }, { principalParts: ["ostendo","ostendere","ostendi","ostentum"] }, { principalParts: ["tango","tangere","tetigi","tactum"] }, { principalParts: ["mitto","mittere","misi","missum"] }, { principalParts: ["dico","dicere","dixi","dictum"] }, { principalParts: ["edo","edere","edidi","editum"] }, { principalParts: ["rego","regere","rexi","rectum"] }, { principalParts: ["eligo","eligere","elegi","lectum"] }, { principalParts: ["claudo","claudere","clausi","clausum"] }, { principalParts: ["tendo","tendere","tetendi","tentum"] }, { principalParts: ["veho","vehere","vexi","vectum"] }, { principalParts: ["deduco","deducere","deduxi","deductum"] }, { principalParts: ["descendo","descendere","descendi","descensum"] }, { principalParts: ["ago","agere","egi","actum"] }, { principalParts: ["duco","ducere","duxi","ductum"] }, { principalParts: ["traho","trahere","traxi","tractum"] }, { principalParts: ["cogo","cogere","coegi","coactum"] }, { principalParts: ["sino","sinere","sivi","situm"] }, { principalParts: ["pono","ponere","posui","positum"] }, { principalParts: ["prodo","prodere","prodidi","proditum"] }, { principalParts: ["cado","cadere","cecidi","casum"] }, { principalParts: ["frango","frangere","fregi","fractum"] }, { principalParts: ["rumpo","rumpere","rupi","ruptum"] }, { principalParts: ["pello","pellere","pepuli","pulsum"] }, { principalParts: ["caedo","caedere","cecidi","caesum"] }, { principalParts: ["laedo","laedere","laesi","laesum"] }, { principalParts: ["occido","occidere","occidi","occisum"] }, { principalParts: ["vinco","vincere","vici","victum"] }, { principalParts: ["gero","gerere","gessi","gestum"] }, { principalParts: ["premo","premere","pressi","pressum"] }, { principalParts: ["cedo","cedere","cessi","cessum"] }, { principalParts: ["parco","parcere","peperci","parsum"] }, { principalParts: ["defendo","defendere","defendi","defensum"] }, { principalParts: ["cingo","cingere","cinxi","cinctum"] }, { principalParts: ["cano","canere","cecini","cantum"] }, { principalParts: ["lego","legere","legi","lectum"] }, { principalParts: ["scribo","scribere","scripsi","scriptum"] }, { principalParts: ["iacio","iacere","ieci","iactum"] }, { principalParts: ["pario","parere","peperi","partum"] }, { principalParts: ["cupio","cupere","cupivi","cupitum"] }, { principalParts: ["facio","facere","feci","factum"] }, { principalParts: ["incipio","incipere","incepi","inceptum"] }, { principalParts: ["fugio","fugere","fugi","fugitum"] }, { principalParts: ["recipio","recipere","recepi","receptum"] }, { principalParts: ["eripio","eripere","eripui","ereptum"] }, { principalParts: ["rapio","rapere","rapui","raptum"] }, { principalParts: ["interficio","interficere","interfeci","interfectum"] }, { principalParts: ["respicio","respicere","respexi","respectum"] }, { principalParts: ["capio","capere","cepi","captum"] }, { principalParts: ["ardeo","ardere","arsi","arsum"] }, { principalParts: ["debeo","debere","debui","debitum"] }, { principalParts: ["misceo","miscere","miscui","mixtum"] }, { principalParts: ["doceo","docere","docui","doctum"] }, { principalParts: ["censeo","censere","censui","censum"] }, { principalParts: ["fleo","flere","flevi","fletum"] }, { principalParts: ["terreo","terrere","terrui","territum"] }, { principalParts: ["iubeo","iubere","iussi","iussum"] }, { principalParts: ["augeo","augere","auxi","auctum"] }, { principalParts: ["moveo","movere","movi","motum"] }, { principalParts: ["habeo","habere","habui","habitum"] }, { principalParts: ["teneo","tenere","tenui","tentum"] }, { principalParts: ["taceo","tacere","tacui","tacitum"] }, { principalParts: ["sustineo","sustinere","sustinui","sustentum"] }, { principalParts: ["respondeo","respondere","respondi","responsum"] }, { principalParts: ["moneo","monere","monui","monitum"] }, { principalParts: ["persuadeo","persuadere","persuasi","persuasum"] }, { principalParts: ["sedeo","sedere","sedi","sessum"] }, { principalParts: ["maneo","manere","mansi","mansum"] }, { principalParts: ["caveo","cavere","cavi","cautum"] }, { principalParts: ["video","videre","vidi","visum"] }, { principalParts: ["comparo","comparare","comparavi","comparatum"] }, { principalParts: ["laboro","laborare","laboravi","laboratum"] }, { principalParts: ["puto","putare","putavi","putatum"] }, { principalParts: ["cogito","cogitare","cogitavi","cogitatum"] }, { principalParts: ["existimo","existimare","existimavi","existimatum"] }, { principalParts: ["spero","sperare","speravi","speratum"] }, { principalParts: ["damno","damnare","damnavi","damnatum"] }, { principalParts: ["sto","stare","steti","statum"] }, { principalParts: ["amo","amare","amavi","amatum"] }, { principalParts: ["curo","curare","curavi","curatum"] }, { principalParts: ["paro","parare","paravi","paratum"] }, { principalParts: ["muto","mutare","mutavi","mutatum"] }, { principalParts: ["tempto","temptare","temptavi","temptatum"] }, { principalParts: ["porto","portare","portavi","portatum"] }, { principalParts: ["oro","orare","oravi","oratum"] }, { principalParts: ["do","dare","dedi","datum"] }, { principalParts: ["iuvo","iuvare","iuvi","iutum"] }, { principalParts: ["laudo","laudare","laudavi","laudatum"] }, { principalParts: ["voco","vocare","vocavi","vocatum"] }, { principalParts: ["nego","negare","negavi","negatum"] }, { principalParts: ["rogo","rogare","rogavi","rogatum"] }, { principalParts: ["narro","narrare","narravi","narratum"] }, { principalParts: ["servo","servare","servavi","servatum"] }, { principalParts: ["fugo","fugare","fugavi","fugatum"] }, { principalParts: ["probo","probare","probavi","probatum"] }, { principalParts: ["pugno","pugnare","pugnavi","pugnatum"] }, { principalParts: ["exspecto","exspectare","exspectavi","exspectatum"] }, { principalParts: ["specto","spectare","spectavi","spectatum"] } ].filter(v => v.principalParts.every(p => p !== null));
  </script>
</body>
</html>